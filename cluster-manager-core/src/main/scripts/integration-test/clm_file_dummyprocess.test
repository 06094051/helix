#!/bin/bash
#integration test for file-based cluster manager

source setup_env.inc

#create config file for static storage cluster
./clm_console.sh --configFile $CONFIG_DIR/cluster-12345-cluster-view.json

#Launch dummy process nodes

$SCRIPT_DIR/espresso_driver.py -c dummy-process -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="--configFile $CONFIG_DIR/cluster-12345-cluster-view.json --cluster storage-cluster-12345 --host localhost --port 8900"

$SCRIPT_DIR/espresso_driver.py -c dummy-process -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="--configFile $CONFIG_DIR/cluster-12345-cluster-view.json --cluster storage-cluster-12345 --host localhost --port 8901"

#$SCRIPT_DIR/espresso_driver.py -c dummy-process -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="--configFile /tmp/cluster-12345.cv --cluster storage-cluster-12345 --host localhost --port 8902"

#$SCRIPT_DIR/espresso_driver.py -c dummy-process -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="--configFile /tmp/cluster-12345.cv --cluster storage-cluster-12345 --host localhost --port 8903"

#$SCRIPT_DIR/espresso_driver.py -c dummy-process -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="--configFile /tmp/cluster-12345.cv --cluster storage-cluster-12345 --host localhost --port 8904"

sleep 3

#verify cluster state
#$SCRIPT_DIR/espresso_driver.py -c cluster-state-verifier -o start -l "cluster-manager/test/integration-test/log4j.properties" --cmdline_props="-zkSvr localhost:2188 -cluster storage-cluster-12345"

$SCRIPT_DIR/espresso_driver.py -c dummy-process -o stop

#$SCRIPT_DIR/espresso_driver.py -c cluster-manager -o stop

echo == GREP SUCCEED ==
find ~/EspressoLogs/ -mmin -10 -print | xargs grep succeed
